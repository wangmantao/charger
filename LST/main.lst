C51 COMPILER V9.02   MAIN                                                                  09/22/2018 14:29:55 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Code\main.c BROWSE INCDIR(.\Libs\Include) DEFINE(FOSC_160000) DEBUG OBJECTE
                    -XTEND PRINT(.\LST\main.lst) OBJECT(.\Output\main.obj)

line level    source

   1          /*                                                                                                        
   2             FOR Charger 2018
   3             --Pin configure--
   4                  ä¸²å£1 ä¸²å£2  Relay1 Relay2  Relay3 Relay4
   5                                (L-short) (ok)    (ng)    (ä¿æŠ¤è¡¨å¤´)
   6          
   7          
   8          */
   9          
  10          /* ------ kiell ä¸­å¼•ç”¨åŸºç¡€å¤´æ–‡ä»¶ --------*/
  11          #include "N76E003.h"
  12          #include "common.h"
  13          #include "delay.h"
  14          #include "SFR_Macro.h"
  15          #include "Function_define.h"
  16          
  17          /* ---------- å®šä¹‰1/3(å¸¸é‡) --------------*/
  18          
  19          
  20          // OKä¿¡å·
  21          #define OK_ON set_P10
  22          #define OK_OFF clr_P10
  23          // NGä¿¡å·
  24          #define NG_ON set_P11
  25          #define NG_OFF clr_P11
  26          // çŸ­è·¯å¼€å…³
  27          #define SHORT_ON set_P12
  28          #define SHORT_OFF clr_P12
  29          // å……ç”µå¼€å…³
  30          #define CHARGE_ON clr_P13       // æ¥å¸¸é—­
  31          #define CHARGE_OFF set_P13
  32          
  33          // å®šæ ¼ç”µæµå¾…æµ‹æ—¶é—´ (æ’å…¥å‡ ç§’åå¼€å§‹æµ‹)
  34          #define RATE_DELAY_TIME 7               // unit:ç§’
  35          #define RATE_MIN_CURRENT 500    // unit:mA
  36          
  37          // å®šæ ¼ç”µæµç»´æŒæ—¶é—´ (ç”µæµå€¼æ£€å‡ºåï¼Œå‡ ç§°åè½¬å…¥çŸ­è·¯æµ‹è¯•)
  38          #define SHORT_DELAY_TIME 7              // unit:ç§’
  39          #define SHORT_MAX_CURRENT 20    // unit:mA
  40          
  41          
  42          
  43          
  44          /* ---------- å®šä¹‰2/3(å˜é‡) --------------*/
  45          static unsigned int DCV_OFF = 1228;             // ç”µå‹è¾“å…¥æœ‰æ²¡æœ‰ä¸‹é™ (4.5v) (4.5/3v)/5v *4095 (å› ä¸ºå–æ 
             -·åˆ†å‹1/3)
  46          static unsigned int DCV_ON = 1638;              // ç”µå‹è¾“å…¥æœ‰æ²¡æœ‰ä¸Šé™ (6v) (6/3v)/5v *4095 (å› ä¸ºå–æ ·åˆ†å
             -‹1/3)
  47          static unsigned int DCV_BAT = 1092;             // battery (4v) (4/3v)/5v *4095 (å› ä¸ºå–æ ·åˆ†å‹1/3)--å¼€å¯æ£€éª
             -Œç”¨
  48          static unsigned int DCV_BAT_DOWN = 273;        // battery (1v) (1/3v)/5v *4095 (å› ä¸ºå–æ ·åˆ†å‹1/3)--çŸ
             -­è·¯æ£€éªŒç”¨
  49          static unsigned int adc_val = 0;                // adcå–æ ·å€¼
  50          //static float adc_val2 = 0;            // adc -> dc ç”µå‹è¾“å…¥
C51 COMPILER V9.02   MAIN                                                                  09/22/2018 14:29:55 PAGE 2   

  51          static unsigned int charge_current = 0;                 // å……ç”µç”µæµ
  52          static unsigned int short_current = 0;          // å……ç”µç”µæµ
  53          static bit pass = 1;                    // æµ‹è¯•ç»“æœ
  54          static bit testing = 0;                 // æµ‹è¯•ä¸­çš„æ ‡è®°
  55          static bit power_offed= 0;                      // å……ç”µå™¨é€€å‡ºæ ‡è®°(å®ƒä»…æœ‰ADCæ§åˆ¶)
  56          static bit power_on= 0;                 // å……ç”µå™¨æ¥ä¸Šæ ‡è®° (è¡¨ç¤ºå¯è¿›å…¥æµ‹è¯•çŠ¶æ€ï¼Œåœ¨jugementåç½®0)
  57          static bit first_boot= 1;                       // å……ç”µå™¨æ¥ä¸Šæ ‡è®°
  58          static bit get_current_ok= 0;                   // å·²æµ‹è¯•ç”µæµæ ‡è®°
  59          static bit time_out= 0;                         // ç­‰å¾…ä¸­æ–­å–æ•°æ®è¶…æ—¶
  60          static bit recovery_ok= 0;                      // å¤å½’ç¡®è®¤æ ‡è®°
  61          static bit adcv_ok = 0;
  62          static bit this_comp_low= 0;
  63          static bit last_comp_low= 0;
  64          static bit this_comp_hi= 0;
  65          static bit last_comp_hi= 0;
  66          static bit bat_out_ok= 0;
  67          static bit bat_down_ok= 0;
  68          
  69          static UINT8 order = 0;
  70          static UINT8 timer0_couter = 0;
  71          static UINT8 current_val[8] ={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  72          static UINT8 adc_res[3] = {0x00,0x00, 0x00};
  73          static UINT8 cmd[6] = {0xAA,0x55,0x02,0xFE,0x01,0x00}; // ç”µæµè¯»å–æŒ‡ä»¤ AA 55 02 FE 01 00 
  74                                                                                                                                                          //04 55 02 FE 01 00 
  75          static UINT32 adc_count = 0;
  76          static UINT8  test_couter = 0;   // å……ç”µç”µæµæµ‹è¯•æ¬¡æ•°
  77          
  78          void chk_power_on_again(void);
  79          /* ---------- å®šä¹‰2/3(å‡½æ•°) --------------*/
  80                  /* ---------- å‡½æ•°ç±»1/4(ä¸­æ–­) --------------*/
  81          void timer0_interrupt() interrupt 1 {
  82   1        // åœæ­¢ADC/ä¸²å£å·¥ä½œï¼Œpass = 0, è®¾ç½® get_current_ok / recovery_ok = 1
  83   1              // timer 0 å…¨å¼€æœ€å¤§50mSï¼›éœ€è¦3ç§’ï¼Œè¦60ä¸ªå¾ªç¯ã€‚
  84   1              //TR0 = 0;
  85   1              if (timer0_couter> 59) //ç»“æŸ
  86   1              {
  87   2                      timer0_couter = 0;
  88   2                      time_out= 1;    
  89   2                      clr_ET0;                //å…³é—­ä¸­æ–­ï¼Œä»¥å…å½±å“timer_delay()
  90   2              }
  91   1              else{
  92   2                      timer0_couter ++;
  93   2                      //set_TR0;
  94   2              }
  95   1      }
  96          
  97          void ifBatOut(){
  98   1              if(adc_val > DCV_BAT && P13 == 1 ){            //æœªçŸ­è·¯çŠ¶æ€ä¸‹             //  æ”¾ç”µçš„ä¸‹é™å€¼ï¼Œå’Œç”µæ± çš„æ£€
             -æµ‹å€¼ ï¼Œç”¨åŒæ ·çš„4.5Vã€‚p13=CHARGE å¸¸é—­æ‰“å¼€ï¼Œä¸å……ç”µ
  99   2                      if(adc_count > 50000){                                  // 1.5ç§’æŒç»­é«˜
 100   3                              adc_count = 0;
 101   3                              bat_out_ok = 1;
 102   3                              clr_ADCEN;                              //      å¼€å§‹æµ‹è¯•ï¼Œåœç”¨ADC
 103   3                      }
 104   2                      else{
 105   3                              adc_count++;
 106   3                              clr_ADCF; set_ADCS;             //æ²¡æœ‰å¤å½’ï¼Œæ¥ç€ADCæ£€æµ‹                                
 107   3                      }
 108   2              }
 109   1              else {
 110   2                      clr_ADCF; set_ADCS;             //æ²¡æœ‰å¤å½’ï¼Œæ¥ç€ADCæ£€æµ‹
 111   2              }
C51 COMPILER V9.02   MAIN                                                                  09/22/2018 14:29:55 PAGE 3   

 112   1      }
 113          
 114          void ifBatDown(){
 115   1              if(adc_val < DCV_BAT_DOWN && P13 == 1 ){               //çŸ­è·¯çŠ¶æ€ä¸‹, ç”µæ± ç”µå‹1Vä»¥ä¸‹          
 116   2                      if(adc_count > 50000){                                  // 1.5ç§’æŒç»­é«˜
 117   3                              adc_count = 0;
 118   3                              bat_down_ok = 1;
 119   3                              clr_ADCEN;                              //      å¼€å§‹æµ‹è¯•ï¼Œåœç”¨ADC
 120   3                      }
 121   2                      else{
 122   3                              adc_count++;
 123   3                              clr_ADCF; set_ADCS;             //æ²¡æœ‰å¤å½’ï¼Œæ¥ç€ADCæ£€æµ‹                                
 124   3                      }
 125   2              }
 126   1              else {
 127   2                      clr_ADCF; set_ADCS;             //æ²¡æœ‰å¤å½’ï¼Œæ¥ç€ADCæ£€æµ‹
 128   2              }
 129   1      }
 130          
 131          void adc_interrupt() interrupt 11 {             
 132   1              adc_val= ADCRH; adc_val<<= 4; adc_val|= (ADCRL & 0X0F);  // 16h -> dec
 133   1              //F1: æœªåœ¨æµ‹è¯•çŠ¶æ€, å……ç”µå™¨å†æ¬¡æ’å…¥æ£€æµ‹
 134   1              if(~testing){                                   //å¼€å§‹æµ‹è¯•å‰ï¼Œæ’å…¥ç”µæºæ£€æµ‹ç”¨æ­¤æ®µ
 135   2                      chk_power_on_again();
 136   2              }
 137   1              else{                                   // ç”µæ± è¾“å‡ºæ£€æµ‹, æˆ–ç”µæ± è¢«çŸ­è·¯
 138   2                      /*
 139   2                      // ç”¨äºåªæ£€æµ‹ç”µæ± ç”µå‹ä¸Šå‡
 140   2                      if(adc_val > DCV_BAT && P13 == 1 ){        // æ”¾ç”µçš„ä¸‹é™å€¼ï¼Œå’Œç”µæ± çš„æ£€æµ‹å€¼ ï¼Œç”¨åŒæ ·çš„4.5V
             -ã€‚p13=CHARGE å¸¸é—­æ‰“å¼€ï¼Œä¸å……ç”µ
 141   2                              if(adc_count > 50000){                                  // 1.5ç§’æŒç»­é«˜
 142   2                                      adc_count = 0;
 143   2                                      bat_out_ok = 1;
 144   2                                      clr_ADCEN;                              //      å¼€å§‹æµ‹è¯•ï¼Œåœç”¨ADC
 145   2                              }
 146   2                              else{
 147   2                                      adc_count++;
 148   2                                      clr_ADCF; set_ADCS;             //æ²¡æœ‰å¤å½’ï¼Œæ¥ç€ADCæ£€æµ‹                                
 149   2                              }
 150   2                      }
 151   2                      else {
 152   2                              clr_ADCF; set_ADCS;             //æ²¡æœ‰å¤å½’ï¼Œæ¥ç€ADCæ£€æµ‹
 153   2                      }
 154   2                      */
 155   2      
 156   2                      // ç”¨äºç”µæ± ç”µå‹ä¸Šå‡å’Œä¸‹é™çš„æ£€æµ‹
 157   2                      if(P12 == 0) 
 158   2                              ifBatOut();             // æœªçŸ­è·¯æ—¶æ£€æµ‹ç”µæ± æœ‰è¾“å‡º            
 159   2                      else
 160   2                              ifBatDown();            // çŸ­è·¯æ—¶æ£€æµ‹ç”µæ± æœ‰ä¸‹é™
 161   2              }                                                               
 162   1              // ADCçš„æœ€åçŠ¶æ€ç”±ifæ®µå†…éƒ¨caseå†³å®š
 163   1      }
 164          
 165          // è·å–ç”µæµå€¼ UART0 ä¸­æ–­
 166          void uart0_interrupt() interrupt 4 {
 167   1        if(RI){
 168   2              if (order > 7)
 169   2                      order = 0;
 170   2          current_val[order] = Receive_Data_From_UART0();;  // è·å–ç”µæµç»“æœ
 171   2          //Send_Data_To_UART1( current_val[order]);
 172   2          if(order == 7){
C51 COMPILER V9.02   MAIN                                                                  09/22/2018 14:29:55 PAGE 4   

 173   3            order = 0;
 174   3            get_current_ok =1;
 175   3          }
 176   2          else {
 177   3            order ++;
 178   3          }
 179   2          clr_RI;
 180   2        }
 181   1      
 182   1        if(TI){
 183   2              clr_TI;
 184   2        }
 185   1      }
 186          
 187          void uart1_interrup(void) interrupt 15 {
 188   1        if(TI_1){
 189   2          clr_TI_1;
 190   2        }
 191   1      }
 192          
 193                  /* ---------- å‡½æ•°ç±»2/3(é…ç½®) --------------*/
 194          void chk_power_on_again(){
 195   1              // æµ‹è¯•ç»“æŸï¼Œè¦æ‹”æ‰ç”µæºï¼Œæ‰èƒ½æœ‰ä»¥ä¸‹åŠ¨ä½œ
 196   1              // æ‰€ä»¥è¦å…ˆæ£€æŸ¥ADC æœ‰ä¸€ä¸ªä½ç”µå‹ï¼Œä¹‹åå†æœ‰ä¸€ä¸ªé«˜ç”µå‹ï¼Œæ‰è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„power_on
 197   1              if (first_boot && (adc_val > DCV_ON )){                 //case 1: å¼€æœºæ—¶æœ‰ç”µæº -> å¯ä»¥é©¬ä¸Šå¼€å§‹æµ‹è¯•
 198   2                      power_on = 1;
 199   2                      CHARGE_ON;                      // ä¸Šç”µæ—¶æ‰§è¡Œ charge
 200   2                      //SBUF=0X11;
 201   2                      clr_ADCEN;                      // å¼€å§‹æµ‹è¯•ï¼Œåœç”¨ADC
 202   2              }
 203   1              else {                                                                          //case 2: å¼€æœºæ—¶æ— ç”µæº -> åŒä¸€èˆ¬æƒ…å†µ ->å…ˆæ£€æµ‹æœ‰ä½ï¼Œå†æ£€æµ‹æœ‰é«˜
 204   2      
 205   2                      if (~power_offed && adc_val < DCV_OFF ){                                        //              åˆ¤æ–­poweroffedçš„ä¸¤ç§æƒ…å†µ
 206   3                              this_comp_low = 1;
 207   3                              if(this_comp_low != last_comp_low){             // è¦é˜²é”™æŠ–åŠ¨, ä¸ä¸Šæ¬¡ä¸åŒå°±è¦é‡æ–°è®¡æ•°
 208   4                                      adc_count =0;
 209   4                              }
 210   3                              else
 211   3                                      adc_count ++;
 212   3                              //if(adc_count > 50000){                                // 1.5ç§’å†…ä¸€ç›´å°ç”µå‹, ä¿è¯æ‹”æ‰å……ç”µå™¨æ—¶ï¼Œæ¥è§¦ä¸è‰¯æœ‰é«˜
             -ç”µå‹è¯¯åˆ¤è€Œ restJugement
 213   3                              if(adc_count > 33333){                          // 1ç§’å†…ä¸€ç›´å°ç”µå‹, ä¿è¯æ‹”æ‰å……ç”µå™¨æ—¶ï¼Œæ¥è§¦ä¸è‰¯æœ‰é«˜ç”µå
             -‹è¯¯åˆ¤è€Œ restJugement
 214   4                                      power_offed = 1;        
 215   4                                      adc_count = 0;
 216   4                              }                               
 217   3                      }
 218   2                      else{
 219   3                              this_comp_low = 0;
 220   3                      }
 221   2                      last_comp_low = this_comp_low;
 222   2      
 223   2                      // ------------ ä»¥ä¸Šä¸ºç¡®è®¤æœ‰æ•ˆçš„power_offed, ä¾›ä¸‹é¢ç”¨-------------------
 224   2      
 225   2                      if(power_offed && (adc_val > DCV_ON)){   //             ç”±power_offedçš„å†³å®šæ˜¯å¦ power_on
 226   3                              this_comp_hi = 1;
 227   3                              if(this_comp_hi != last_comp_hi){               // è¦é˜²é”™æŠ–åŠ¨, ä¸ä¸Šæ¬¡ä¸åŒå°±è¦é‡æ–°è®¡æ•°
 228   4                                      adc_count =0;
 229   4                              }
 230   3                              else
 231   3                                      adc_count ++;
 232   3                              //if(adc_count > 50000){                                // 1.5ç§’å†…ä¸€ç›´å°ç”µå‹, ä¿è¯æ‹”æ‰å……ç”µå™¨æ—¶ï¼Œæ¥è§¦ä¸è‰¯æœ‰é«˜
C51 COMPILER V9.02   MAIN                                                                  09/22/2018 14:29:55 PAGE 5   

             -ç”µå‹è¯¯åˆ¤è€Œ restJugement
 233   3                              if(adc_count > 33333){                          // 1ç§’å†…ä¸€ç›´å°ç”µå‹, ä¿è¯æ‹”æ‰å……ç”µå™¨æ—¶ï¼Œæ¥è§¦ä¸è‰¯æœ‰é«˜ç”µå
             -‹è¯¯åˆ¤è€Œ restJugement
 234   4                                      power_on = 1;   
 235   4                                      CHARGE_ON;                              // ä¸Šç”µæ—¶æ‰§è¡Œcharge
 236   4                                      adc_count = 0;
 237   4                                      clr_ADCEN;                      // å¼€å§‹æµ‹è¯•ï¼Œåœç”¨ADC     
 238   4                              }                               
 239   3                      }
 240   2                      else{
 241   3                              this_comp_hi = 0;
 242   3                      }
 243   2                      last_comp_hi = this_comp_hi;
 244   2      
 245   2                      // ------------ ä»¥ä¸Šä¸ºç¡®è®¤æœ‰æ•ˆçš„power_on, ä¾›ä¸‹é¢ç”¨-------------------
 246   2      
 247   2                      if(~power_on){                                                  // ä»¥ä¸Šæ²¡æœ‰äº§ç”Ÿæœ‰æ•ˆçš„power_on, ç»§ç»­ADC
 248   3                              clr_ADCF; set_ADCS;
 249   3                      }
 250   2              }
 251   1      }
 252          
 253          void ioConf(){
 254   1              //  å‡†åŒå‘ï¼Œå·²ç»åœ¨ä¸²å£åˆå§‹åŒ–å®šä¹‰
 255   1              //ä¸²å£1  p06 / p07
 256   1              //ä¸²å£2  p16 /p02
 257   1      
 258   1              P10_PushPull_Mode;                      // Relay 1 control - for ok -> p10
 259   1              P11_PushPull_Mode;                      // Relay 2 control - for ng -> p11
 260   1              P12_PushPull_Mode;                      // Relay 3 control - for short -> p12
 261   1              P13_PushPull_Mode;                      // Relay 4 control - for charge -> p13
 262   1              P03_Quasi_Mode;                         // sys_reset (changed: ç”µæ± å¼€ä¿¡å·è¾“å…¥)
 263   1              P04_Quasi_Mode;                         // ng_reset
 264   1              set_P03;
 265   1              set_P04;
 266   1      
 267   1      
 268   1              Enable_ADC_AIN0;                        // AIN0 P17
 269   1      
 270   1              set_PWMDIV0;                            // pwm 128åˆ†é¢‘ç‡
 271   1              set_PWMDIV1;
 272   1              set_PWMDIV2;
 273   1      }
 274          
 275          
 276                  /* ---------- å‡½æ•°ç±»3/3(åŠŸèƒ½) --------------*/
 277          
 278           void timer0_monitor_start(){
 279   1              // é…ç½®å®šæ—¶æœŸåˆå€¼
 280   1              // å¼€å¯å®šæ—¶å™¨  -- > å®šæ—¶å™¨æº¢å‡ºæ—¶ï¼Œåœ¨ä¸­æ–­ä¸­å¤„ç†ï¼šåœæ­¢æµ‹è¯•ï¼Œé”™è¯¯è¾“å‡º
 281   1              time_out=0;
 282   1              order = 0;
 283   1          clr_T0M;                                            //T0M=0, Timer0 Clock = Fsys/12
 284   1          TMOD |= 0x01;                                       //Timer0 is 16-bit mode
 285   1          TL0 = 0x00;
 286   1          TH0 = 0x00;
 287   1          set_ET0;
 288   1          set_TR0;
 289   1       }
 290          
 291           void timer0_monitor_stop(){
 292   1              // å…³é—­å®šæ—¶å™¨
C51 COMPILER V9.02   MAIN                                                                  09/22/2018 14:29:55 PAGE 6   

 293   1              TR0 = 0;
 294   1              clr_ET0;        
 295   1              // é‡ç½®å®šæ—¶å™¨çš„å€¼
 296   1       }
 297          
 298          void reset_judgement(){
 299   1          SHORT_OFF;     // æœ€åæ— è®ºOKã€NGéƒ½ä¿æŒçŸ­è·¯çŠ¶æ€ï¼Œä»…åœ¨æ­¤è¿˜åŸ
 300   1              OK_OFF; NG_OFF; // ok Relay =0 ; ng Relay = 0;
 301   1              Timer0_Delay1ms(50);
 302   1              CHARGE_ON;              // æœ€åæ— è®ºOKã€NGçš„åˆ¤å®šè¿›è¡Œå¤ä½ï¼Œè¦è¿›è¡Œæµ‹è¯•ï¼Œæ€»æ˜¯ä»å……ç”µå¼€å§‹
 303   1      }
 304          
 305          void do_a_judgement(){
 306   1              //CHARGE_OFF;
 307   1              // Timer0_Delay1ms(100);
 308   1              // 1. è¾“å‡ºæµ‹è¯•ç»“æœ(å…ˆç½®0å†ç½®1, é˜²æ­¢ä¸¤ä¸ªåŒæ—¶æœ‰æ•ˆï¼‰
 309   1              if(pass){
 310   2                      NG_OFF; 
 311   2                      OK_ON;
 312   2              }
 313   1              else {
 314   2                      OK_OFF; 
 315   2                      NG_ON;
 316   2              }
 317   1              // 2. è®¾æµ‹è¯•ç»“æŸæ ‡è®° & å¾…å¼€å§‹æ–°ä¸€è½®å……ç”µæ’å…¥æ£€æµ‹
 318   1              first_boot = 0;
 319   1              testing = 0;
 320   1              power_on = 0; 
 321   1              power_offed = 0;
 322   1      
 323   1              // 3. é‡æ–°å¼€å§‹ADCä¾¦æµ‹(å¼€å¯ADCä¸­æ–­)
 324   1              set_ADCEN;
 325   1              set_ADCS;
 326   1      
 327   1      
 328   1      }
 329          
 330          void send_cmd(){
 331   1        UINT8 order = 0;
 332   1        while (order <= 5){
 333   2          Send_Data_To_UART0(cmd[order]);
 334   2         order ++;
 335   2        }
 336   1      }
 337          
 338          void test_flow(){
 339   1              int tempV = 0;
 340   1              pass = 1;
 341   1              testing = 1;                    // æ ‡è®°è¿›å…¥æµ‹è¯•ä¸­
 342   1              reset_judgement();              // è¿›å…¥æµ‹è¯•çŠ¶è¯šåï¼ŒOK/NG/shortç»§ç”µå™¨å¤ä½
 343   1      
 344   1              // -----------------------------------------------RATE å……ç”µç”µæµæµ‹è¯•
 345   1              // 0x00c8 <0.2A  0x012c< 0.3A 0x01F4< 0.5A 0x044c< 1.1A
 346   1              // å…¬å¼ 256 * é«˜8ä½ + 244ï¼ˆä½8ä½æ‰€è½¬ï¼‰ = 500 mA (0x01F4)
 347   1      
 348   1              Timer0_Delay1ms(1000);  // åˆæ¬¡ç­‰å¾…1s
 349   1              // å¾ªç¯æµ‹ç”µæµ
 350   1              test_couter = 0;
 351   1              while( pass && test_couter < 35){                       // æœ‰ä¸€é¡¹ä¸º0 ï¼Œå³ä¸º0ï¼ˆä¸ï¼‰35æ¬¡ï¼Œçº¦æµ‹10ç§’ 
 352   2                get_current_ok = 0;
 353   2                timer0_monitor_start();
 354   2                send_cmd();
C51 COMPILER V9.02   MAIN                                                                  09/22/2018 14:29:55 PAGE 7   

 355   2                while(~get_current_ok && ~time_out);  // å³æ²¡å¾—åˆ°ç”µæµï¼Œåˆæ²¡è¶…æ—¶ä¸€ç›´ç­‰
 356   2                timer0_monitor_stop();
 357   2                if(time_out)
 358   2                      pass= 0;
 359   2                if(get_current_ok)                                    // å–å¾—ç”µæµ
 360   2                      tempV = current_val[5]; tempV <<= 8; tempV |= (current_val[4] & 0xFF);
 361   2                if (tempV > 0x00c8)           
 362   2                  break;                                                              // å¦‚æœç”µæµå€¼è¾“å‡ºOKï¼Œä¿è¯ä¸å†ä¸ºç”µæµèµ‹æ–°å€¼
 363   2                else
 364   2                      test_couter ++;
 365   2                 Timer0_Delay1ms(350);                                // ä¸‹ä¸€ä¸ªé‡å¤çš„é—´éš”ï¼ˆç”µæµè¡¨çš„é‡‡æ ·ç‡ä¸ºæ¯ç§’3æ¬¡)
 366   2              }
 367   1        
 368   1              // å¾ªç¯å¤šæ¬¡æµ‹å¾—çš„ç»“æœåˆ¤å®š
 369   1              if(~pass || tempV < 0x00c8){  
 370   2                      pass = 0;                               
 371   2              do_a_judgement();       // NG åˆ¤å®šè¾“å‡º
 372   2              return;   
 373   2              }
 374   1       
 375   1        // -----------------------------------------------SHORT çŸ­è·¯ç”µæµæµ‹è¯•
 376   1        CHARGE_OFF;
 377   1        Timer0_Delay1ms(1500);                 // æ–­å¼€å……ç”µå¹¶å»¶è¿Ÿ0.6s -> 1.5s
 378   1      
 379   1              /* æ–¹æ¡ˆ1 */
 380   1        /*
 381   1        SHORT_ON;                                              // æ‰§è¡Œæ”¾ç”µä¸çŸ­è·¯ -> ç§»è‡³è·å¾—ä¿¡å·å
 382   1        OK_ON; Timer0_Delay1ms(1000); OK_OFF; // å‘å‡ºOKæŒ‡ç¤º 1s
 383   1         while (P03);
 384   1         Timer0_Delay1ms(2000);            // å»¶è¿Ÿ2s 
 385   1      */
 386   1              /* æ–¹æ¡ˆ2 */
 387   1              // æ”¾å¼€å……ç”µ->ç»™å‡º1ç§’OKä¿¡å·(åŒæ—¶æ”¾ç”µ0.5ç§’)->å¾—åˆ°å›å¤å->æ£€éªŒç”µæ± ç”µå‹å‡èµ·->æ‰§è¡
             -ŒçŸ­è·¯->æ£€éªŒç”µæ± ç”µå‹ä¸‹é™ -> æµ‹ç”µæµ        
 388   1        //SHORT_ON;   
 389   1        OK_ON;
 390   1        Timer0_Delay1ms(500);
 391   1        //SHORT_OFF;   // æ”¾ç”µ0.5s
 392   1        Timer0_Delay1ms(500); 
 393   1        OK_OFF; // å‘å‡ºOKæŒ‡ç¤º 1s
 394   1      
 395   1         while (P03);
 396   1        
 397   1         bat_out_ok = 0;
 398   1        set_ADCEN; clr_ADCF; set_ADCS; set_ADCEN;
 399   1        while(~bat_out_ok);    //æ­¤æ—¶ç”µå‹å€¼ > 4.8V < 8V,æŒç»­1ç§’é’Ÿï¼Œè¡¨ç¤ºBAT,OK
 400   1      
 401   1        SHORT_ON;             // ç”µæ± å¼€å¯ ï¼ã€‰ shorted ï¼ ã€‰ ç”µæ± ç”µå‹ä¸‹é™ ï¼ ã€‰ æµ‹çŸ­è·¯ç”µæµ
 402   1      
 403   1        bat_down_ok = 0;    // çŸ­è·¯æµ‹è¯•ä¸ç­‰ç”µå‹ä¸‹é™
 404   1        set_ADCEN; clr_ADCF; set_ADCS; set_ADCEN;
 405   1        while(~bat_down_ok);   //æ­¤æ—¶ç”µå‹å€¼ > 1V,æŒç»­1ç§’é’Ÿï¼Œè¡¨ç¤ºçŸ­è·¯æœ‰æ•ˆ
 406   1      
 407   1        Timer0_Delay1ms(1000);   //æŸ¥çœ‹ä¼šä¸ä¼šæ˜¾ç¤º"E"
 408   1      
 409   1      
 410   1      /* æµ‹è¯•ç”µæµè¾¨åˆ«OK */
 411   1        get_current_ok = 0;
 412   1        timer0_monitor_start();
 413   1        send_cmd();
 414   1              while(~get_current_ok && ~time_out);    // Waiting A meter return
 415   1        timer0_monitor_stop();
C51 COMPILER V9.02   MAIN                                                                  09/22/2018 14:29:55 PAGE 8   

 416   1        if(time_out){
 417   2              pass= 0;
 418   2        }
 419   1        if(get_current_ok){
 420   2              tempV = current_val[5]; tempV <<= 8; tempV |= (current_val[4] & 0xFF);
 421   2        } 
 422   1        //tempV = 0x0003;
 423   1        //pass = 1;
 424   1        if(~pass || tempV > 0x0014){  // < 0.02A
 425   2              Timer0_Delay1ms(1500); //ä¿ç•™çœ‹ç”µæµçš„æ—¶é—´ 1500ms *2 =3s
 426   2          pass = 0; do_a_judgement(); 
 427   2          //SHORT_OFF;                  // æ— è®ºOKã€NGéƒ½ä¿æŒçŸ­è·¯çŠ¶æ€
 428   2          Timer0_Delay1ms(1000);      
 429   2          SHORT_OFF;
 430   2              Timer0_Delay1ms(200);   
 431   2              CHARGE_ON;                              //åšOKã€NGçš„åˆ¤åæ”¹å˜charge ON, è®©è¾“å…¥æœ‰æ„ŸçŸ¥
 432   2          return; // ---> return (ng shorted cancel)
 433   2        }
 434   1      
 435   1          SHORT_OFF; Timer0_Delay1ms(100); CHARGE_ON; // Relay å¤ä½åï¼Œå†ç‚¹OKç¯
 436   1          do_a_judgement();
 437   1      
 438   1      }
 439          
 440          void sys_reset(){
 441   1              set_SWRST;      
 442   1      }
 443          
 444          void ng_reset(){
 445   1              NG_OFF;
 446   1      }
 447          /*
 448          æµç¨‹è¯´æ˜ï¼š
 449          ä¸Šç”µæ£€æŸ¥æœ‰æ²¡æœ‰è¾“å‡º
 450          è¾“å‡ºæœ‰ï¼Œç”¨relay æ¥ä¸Šç”µæ± 
 451          ç­‰å¾…8ç§’ ï¼ˆå¸¸é‡ï¼‰
 452          */
 453          void main(){
 454   1      
 455   1               /*IAP å†™ä¿æŠ¤ */
 456   1              set_IAPEN;  //å¯ç”¨IAP
 457   1              set_CFUEN;      // è¦æ›´æ–°configåŒºåŸŸ
 458   1              IAPAH = 0x00; //cfg0 åœ°å€ä¸º 0000h       
 459   1              IAPAL = 0x00;
 460   1              IAPFD = 0xFD; //CFG0 çš„æ•°æ®
 461   1              IAPCN = 0XE1; //CFG å†™
 462   1              set_IAPGO; // å¼€å§‹æ‰§è¡ŒIAP
 463   1              clr_IAPEN;
 464   1      
 465   1      
 466   1              // åˆå§‹åŒ–
 467   1              ioConf();       
 468   1              OK_OFF;
 469   1              NG_OFF;
 470   1              SHORT_OFF;
 471   1              CHARGE_ON;                              //å¼€æœºdefault charge
 472   1         Timer0_Delay1ms(1000);
 473   1      
 474   1              set_ES;
 475   1              set_REN;
 476   1              set_EADC;
 477   1      
C51 COMPILER V9.02   MAIN                                                                  09/22/2018 14:29:55 PAGE 9   

 478   1      
 479   1              clr_ADCF;
 480   1              set_ADCEN;
 481   1              set_ADCS;
 482   1      
 483   1              set_EA; 
 484   1      
 485   1      
 486   1              InitialUART0_Timer1(115200);
 487   1              //InitialUART1_Timer3(115200);
 488   1      
 489   1              while (1){
 490   2                      if(power_on){
 491   3                              testing = 1;  
 492   3                              clr_ADCEN;
 493   3                              test_flow();  //å¼€å§‹ä¸€è½®æµ‹è¯•
 494   3                      }
 495   2                      Timer0_Delay1ms(500);
 496   2      
 497   2                      /* ä¸¤ä¸ªå¤ä½ä¿¡å· */
 498   2                      if(P04 == 0){
 499   3                              if(P11 ==1 )    // å½“NGç”Ÿæ•ˆæ—¶
 500   3                                      ng_reset();    // NGå¤ä½
 501   3                              else
 502   3                                      sys_reset();   // ç³»ç»Ÿå¤ä½
 503   3                      }
 504   2      
 505   2                      /*
 506   2                      if(P03 == 0) {
 507   2                              sys_reset();
 508   2                      }
 509   2                      */
 510   2              }
 511   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1337    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     38       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     15    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
